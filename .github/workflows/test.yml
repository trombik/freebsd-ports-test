name: Test

#   /home/runner/work
#   ├── ccache
#   ├── distfiles
#   ├── freebsd-ports-test
#   │   └── freebsd-ports-test
#   └── poudriere
#       ├── data
#       ...

on:
  - push

jobs:
  test:
    runs-on: ubuntu-latest
    name: A job to run test in FreeBSD
    env:
      PORTS_URL:  https://github.com/freebsd/freebsd-ports.git
      MYTOKEN2: "value2"
    steps:
    - uses: actions/checkout@v4
    - name: Test in FreeBSD
      id: test
      uses: vmactions/freebsd-vm@v1
      with:
        envs: 'MYTOKEN2'
        usesh: true
        sync: rsync
        copyback: true
        prepare: |
          pwd
          ls -al
          pkg install -y ports-mgmt/poudriere-devel devel/git sysutils/tree
          mkdir -p work/ccache work/poudriere work/distfiles

          echo "" > /usr/local/etc/poudriere.conf
          echo "NO_ZFS=yes" >> /usr/local/etc/poudriere.conf
          echo "RESOLV_CONF=/etc/resolv.conf" >> /usr/local/etc/poudriere.conf
          echo "USE_PORTLINT=no" >> /usr/local/etc/poudriere.conf
          echo "DISTFILES_CACHE=`pwd`/work/distfiles" >> /usr/local/etc/poudriere.conf
          echo "CCACHE_DIR=`pwd`/work/ccache"
          echo "SVN_HOST=svn.FreeBSD.org" >> /usr/local/etc/poudriere.conf
          echo "GIT_PORTSURL=${PORTS_URL}" >> /usr/local/etc/poudriere.conf
          echo "BASEFS=`pwd`/work/poudriere" >> /usr/local/etc/poudriere.conf
          cat /usr/local/etc/poudriere.conf

          poudriere ports -c -p default -m git+https -B main
          poudriere jail -c -j 140amd64 -m ftp -v 14.0-RELEASE

        run: |
          poudriere bulk -j 140amd64 -p default games/sl
          rm -rf /home/runner/work/poudriere/jails
          rm -rf /home/runner/work/poudriere/ports
          find /home/runner/work/poudriere/data -type l | xargs -n 1 rm

    - name: Test on the host
      run: |
        pwd
        ls -alh
        tree /home/runner/work/poudriere
