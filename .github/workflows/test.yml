name: Test

#   /home/runner/work
#   ├── ccache
#   ├── distfiles
#   ├── freebsd-ports-test
#   │   └── freebsd-ports-test
#   └── poudriere
#       ├── data
#       ...

on:
  - push

jobs:
  test:
    runs-on: ubuntu-latest
    name: A job to run test in FreeBSD
    env:
      PORTS_URL:  https://github.com/freebsd/freebsd-ports.git
      MYTOKEN2: "value2"
    steps:
    - uses: actions/checkout@v4
    - name: Test in FreeBSD
      id: test
      uses: vmactions/freebsd-vm@v1
      with:
        envs: 'MYTOKEN2'
        usesh: true
        sync: rsync
        copyback: true
        prepare: |
          pwd
          ls -al
          pkg install -y ports-mgmt/poudriere-devel devel/git sysutils/tree
          mkdir -p work/ccache work/poudriere work/distfiles work/poudriere/data/logs/bulk

          # minimum configuration for poudriere
          echo "" > /usr/local/etc/poudriere.conf
          echo "NO_ZFS=yes" >> /usr/local/etc/poudriere.conf
          echo "RESOLV_CONF=/etc/resolv.conf" >> /usr/local/etc/poudriere.conf
          echo "USE_PORTLINT=no" >> /usr/local/etc/poudriere.conf
          echo "DISTFILES_CACHE=/home/runner/work/distfiles" >> /usr/local/etc/poudriere.conf
          echo "CCACHE_DIR=`pwd`/work/ccache"
          echo "SVN_HOST=svn.FreeBSD.org" >> /usr/local/etc/poudriere.conf
          echo "GIT_PORTSURL=${PORTS_URL}" >> /usr/local/etc/poudriere.conf
          echo "BASEFS=`pwd`/work/poudriere" >> /usr/local/etc/poudriere.conf
          cat /usr/local/etc/poudriere.conf

          poudriere ports -c -p default -m git+https -B main
          poudriere jail -c -j 140amd64 -m ftp -v 14.0-RELEASE

        run: |
          pwd
          tree .
          ORIGINS=`find * -type d -depth 1`
          echo ${ORIGINS}
          poudriere status  -fH
          poudriere status
          BULK_PATH=`poudriere status  -fH | cut -f 14`
          LOG_PATH="${BULK_PATH}/logs"

          for O in ${ORIGINS}; do
            poudriere bulk -j 140amd64 -p default "${P}"
          done

          BUILT_PORTS=`poudriere status  -fHr | grep "Built ports:" | cut -f 2 -d ":"`

          for F in ${BUILT_PORTS}; do
            echo "Built ports: ${F}"
            echo "--------------------------------"
            cat "${LOG_PATH}/${F}.log"
            echo "--------------------------------"
          done

          for F in `ls -1 "${LOG_PATH}/errors"`; do
            if [ -f "${F}" ]; then
              echo "Error log: ${F}"
              echo "--------------------------------"
              cat "${F}"
              echo "--------------------------------"
            fi
          done

          # remove jails and ports, takes too long to sync them on host
          rm -rf /home/runner/work/poudriere/jails
          rm -rf /home/runner/work/poudriere/ports


    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: poudriere-logs
        path: /home/runner/work/poudriere/data/logs


    - name: Get date
      id: date
      run: date +'DATE=%Y-%m-%d' >> "$GITHUB_OUTPUT"

    - name: Cache distfiles
      # Cache distfiles for one day. there is no appropriate keys for ports
      # development. distfiles change when:
      #
      # * the ports tree is updated
      # * dependency changes
      # * sources and patches are updated
      #
      uses: actions/cache@v4
      with:
        path: /home/runner/work/distfiles
        key: ${{ steps.date.outputs.DATE }}
