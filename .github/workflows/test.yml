name: Test

#   /home/runner/work
#   ├── ccache
#   ├── distfiles
#   ├── freebsd-ports-test
#   │   └── freebsd-ports-test
#   └── poudriere
#       ├── data
#       ...

on:
  - push

jobs:
  test:
    runs-on: ubuntu-latest
    name: A job to run test in FreeBSD
    strategy:
      matrix:
        freebsd_release:

          # see supported releases at:
          # https://github.com/vmactions/freebsd-vm/tree/main/conf
          - "13.2"
          - "14.0"
    env:
      PORTS_URL:  https://github.com/freebsd/freebsd-ports.git
      MYTOKEN2: "value2"
    steps:
    - uses: actions/checkout@v4
    - name: Test in FreeBSD
      id: test
      uses: vmactions/freebsd-vm@v1
      with:
        release: ${{ matrix.freebsd_release }}
        envs: 'MYTOKEN2'
        usesh: true
        sync: rsync
        copyback: true
        prepare: |
          pwd
          ls -al
          pkg install -y ports-mgmt/poudriere-devel devel/git sysutils/tree
          mkdir -p work/ccache work/poudriere work/distfiles work/poudriere/data/logs/bulk

          # minimum configuration for poudriere
          echo "" > /usr/local/etc/poudriere.conf
          echo "NO_ZFS=yes" >> /usr/local/etc/poudriere.conf
          echo "RESOLV_CONF=/etc/resolv.conf" >> /usr/local/etc/poudriere.conf
          echo "USE_PORTLINT=no" >> /usr/local/etc/poudriere.conf
          echo "DISTFILES_CACHE=/home/runner/work/distfiles" >> /usr/local/etc/poudriere.conf
          echo "CCACHE_DIR=`pwd`/work/ccache"
          echo "SVN_HOST=svn.FreeBSD.org" >> /usr/local/etc/poudriere.conf
          echo "GIT_PORTSURL=${PORTS_URL}" >> /usr/local/etc/poudriere.conf
          echo "BASEFS=`pwd`/work/poudriere" >> /usr/local/etc/poudriere.conf
          cat /usr/local/etc/poudriere.conf

          # i.e. 140, 131
          VERSION=`echo ${{ matrix.freebsd_release }} | tr -d '.'`
          ARCH="amd64"
          JAIL_NAME="${VERSION}${ARCH}"
          echo "VERSION=${VERSION}"
          echo "ARCH=${ARCH}"
          echo "JAIL_NAME=${JAIL_NAME}"

          poudriere ports -c -p default -m git+https -B main
          poudriere jail -c -j "${JAIL_NAME}" -m ftp -v ${{ matrix.freebsd_release }}-RELEASE

        run: |
          set -e -x
          TEST_RESULT=1
          pwd
          tree .
          ORIGINS=`find * -type d -depth 1`
          echo "ORIGINS: ${ORIGINS}"
          echo "Creating overlay."
          poudriere ports -c -p overlay -m null -M `pwd`
          echo "List of ports"
          poudriere ports -l

          VERSION=`echo ${{ matrix.freebsd_release }} | tr -d '.'`
          ARCH="amd64"
          JAIL_NAME="${VERSION}${ARCH}"
          echo "VERSION=${VERSION}"
          echo "ARCH=${ARCH}"
          echo "JAIL_NAME=${JAIL_NAME}"

          echo "Starting build."
          for O in ${ORIGINS}; do
            poudriere bulk -j ${JAIL_NAME} -p default -O overlay -b latest -t "${O}"
          done
          poudriere status -fH
          poudriere status -f
          BULK_PATH=`poudriere status  -fH | cut -f 14`
          LOG_PATH="${BULK_PATH}/logs"
          tree ${LOG_PATH}

          OVERLAY_PORTS=`find * -type d -depth 1`
          echo "OVERLAY_PORTS: ${OVERLAY_PORTS}"
          echo "Built ports: ${BUILT_PORTS}"

          ERROR_LOGS=`ls -1 "${LOG_PATH}/errors"`

          if [ -z "${ERROR_LOGS}" ]; then
            echo "Failed build logs: ${ERROR_LOGS}"
            for F in ${ERROR_LOGS}; do
              FILE="${LOG_PATH}/errors/${F}"
              if [ -f "${FILE}" ]; then
                echo "Error log: ${FILE}"
                echo "--------------------------------"
                cat "${FILE}"
                echo "--------------------------------"
              fi
            done
          else
            TEST_RESULT=0
          fi

          # remove jails and ports, takes too long to sync them on host
          chflags -R noschg /home/runner/work/poudriere/jails
          rm -rf /home/runner/work/poudriere/jails
          rm -rf /home/runner/work/poudriere/ports

          if [ ${TEST_RESULT} -eq 1 ]; then
            false
          fi


    - name: Upload logs
      uses: actions/upload-artifact@v4
      with:
        name: poudriere-logs-${{ github.sha }}-${{ matrix.freebsd_release }}
        path: /home/runner/work/poudriere/data/logs


    - name: Get date
      id: date
      run: date +'DATE=%Y-%m-%d' >> "$GITHUB_OUTPUT"

    - name: Cache distfiles
      # Cache distfiles for one day. there is no appropriate keys for ports
      # development. distfiles change when:
      #
      # * the ports tree is updated
      # * dependency changes
      # * sources and patches are updated
      #
      uses: actions/cache@v4
      with:
        path: /home/runner/work/distfiles
        key: ${{ steps.date.outputs.DATE }}
